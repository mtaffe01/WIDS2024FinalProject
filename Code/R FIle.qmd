---
title: "WIDS 2024 Final Project"
author: "Michael Taffe, Melanie Klein, Ramiro Arevalo"
format: html
editor: visual
---

# useful git commands

**This command will update all the branches on your computer** git remote update origin --prune

showing off branch

test

### Loading Packages

```{r}
library(tidyverse)
```

### Gathering Data

```{r}
# Union Data
union_wages <- read_rds("../Data/union_wages.rds")
union_states <- read_rds("../Data/union_states.rds")


# Election Data
house <- read_rds("../Data/house.rds")

# Wage Data
income_distribution <- read_rds("../Data/income_distribution.rds")

# Minimum Wage Data
minimum_wage <- read_csv("../Data/minimum_wage_data.csv")
```

### Cleaning Data

#### Examining data shape

First, lets get an idea of what our data looks like.

```{r}
# look at columns
head(union_wages)
head(union_states)
head(house)
head(income_distribution)
head(minimum_wage)
```

From the head() function we can already see some tidying that needs to be done, mostly in the `house` table. First, to make data analysis easier we will need to combine the `states` and `house` table; this will be done on the year and state columns. however, the state column in the house data set is in uppercase, compared to sentence case in the states table. Next, R has read district in as a string column rather than a numeric column. Examining the data set documentation, this is because 0 is actually "district at large" rather than a district number. This will be taken into account in data analysis.

Next we will look at a quick summary of the data to find very obvious trends.

From the summary, we can see the demographics has most of its variables skewed. This will be examined in closer detail in the exploratory data analysis. only two columns have NA values and each of those columns NA values represent less than 10% of the data. There is not an immediate cause to take action on these NA values, although they will be examined in greater detail in the EDA.

```{r}
# look for NAs and skews
summary(union_wages)
```

The `wages` table has no NA values. There is also nothing in the data documentation that would indicate a numeric value of some kind is being used as an NA value.

```{r}
summary(union_states)
```

Again, there are no NA values in the States data set, although we do see some significantly skewed data.

```{r}
summary(house)
```

in the house data set, we can see a significant amount of NA values in the runoff column

#### Cleaning data script

From a quick look at the shapes and distribution of the tables, the house table will be modified.

```{r}
house <- house |>
  group_by(year, state, district) |> # group for next line
  filter(candidatevotes == max(candidatevotes)) |> #only include candidates that won
  ungroup() |> 
  mutate(state = str_to_sentence(state)) |> # change from all caps to sentence case) 
  select(!(state_fips:office)) |> #Remove unwanted columns
  select(!(stage:candidate)) |> 
  select(!(writein:fusion_ticket)) |> 
  rename(state_abbreviation = state_po) |>  # rename state abbreviation column
  mutate(party = case_when(
    str_detect(party, "DEMOCRAT") ~ "DEMOCRAT",
    str_detect(party, "REPUBLICAN") ~ "REUBLICAN",
    str_detect(party, "INDEPENDENT") ~ "INDEPENDENT"
  )) # Recode of party variable
```

```{r}
union_wages <- union_wages |> 
  filter(facet == "all wage and salary workers") |> 
  distinct(year, .keep_all = TRUE) |> 
  select(-sample_size,
         -at_cap) |> 
  mutate(wage_percent_difference = union_wage_premium_raw, .keep = "unused") |> 
  mutate(wage_percent_difference_adjusted = union_wage_premium_adjusted, .keep = "unused") |> 
  mutate(union_type = facet, .keep = "unused")
```

```{r}
union_states <- union_states |> 
  select(-state_census_code,
         -observations) |> # remove unwanted columns
  mutate(employment_count = employment * 1000, .keep = "unused") |> # column measured in 1000s, this fixes it
  mutate(union_employment_count = members * 1000, .keep = "unused") |> 
  mutate(collective_bargain_employment_count = covered * 1000,
         .keep = "unused") |> 
  rename(
    percent_union = p_members,
    percent_collective_bargain = p_covered
  ) #renamed columns
```

```{r}
income_distribution <- income_distribution |> 
  select(-number) |> # removing unwanted columns
  select(!ends_with("moe")) |> 
  select(year:income_mean) |> 
  distinct(year, race, income_median, income_mean, .keep_all = TRUE) |> # only include one line per year. needed bc of multiple sectors that are not being used in data analysis
  rename(median_income = income_median,
         mean_income = income_mean) # renaming columns
```

```{r}
minimum_wage <- minimum_wage |> 
  select(Year:CPI.Average) |> # selecting relevant columns
  rename(year = Year,
         state = State,
         state_min_wage = State.Minimum.Wage,
         state_min_wage_2020_adj = State.Minimum.Wage.2020.Dollars,
         fed_min_wage = Federal.Minimum.Wage,
         fed_min_wage_2020_adj = Federal.Minimum.Wage.2020.Dollars,
         effective_min_wage = Effective.Minimum.Wage,
         effective_min_wage_2020_adj = Effective.Minimum.Wage.2020.Dollars,
         CPI_avg = CPI.Average
  ) |> # renaming variables
  filter(!state %in% c("U.S. Virgin Islands", "Puerto Rico", "Guam")) |>  # remove territory
  mutate(state_abbreviation = 
           ifelse(is.na(state.abb[match(state, state.name)]),
                  "DC",
                  state.abb[match(state, state.name)]),
         .keep = "unused", .after = year) # replaces state with state abbreviation, NA values coded as DC as DC is the only NA value 
```

```{r}
# seeing what we have left
head(union_wages)
head(union_states)
head(house)
head(income_distribution)
head(minimum_wage)
```

```{r}
# seeing what years we have
range(union_wages$year) #ntl
range(union_states$year) # state
range(house$year) # state
range(income_distribution$year) # ntl
range(minimum_wage$year) # state
```

### Combining dataframes

The states data set has five entries for each year for each of the five `sectors`. For this project we will use the `total` sector. A decades column will also be added.

#### State Dataframes

```{r}
full_state_data <- union_states |> 
  filter(sector == "Total") |> 
  select(-sector,
         -state) |> 
  left_join(house, by = c("year", "state_abbreviation")) |> 
  mutate(decade = paste0((year - year %% 10), "s"),
         party_binary = ifelse(party == "DEMOCRAT", 1, 0)) |> 
  left_join(minimum_wage, by = c("year", "state_abbreviation")) |> 
  group_by(year, state) |> 
  mutate(party_state_avaerage = mean(party_binary)) |>
  ungroup() |> 
  mutate(state = state.name[match(state_abbreviation, state.abb)], # fix state encoding
         regions = state.region[match(state_abbreviation, state.abb)]) # fix region encoding
```

```{r}
state_column_list = c("year", "decade", "state", "state_abbreviation",
                      "regions", "district", "party", "party_binary",
                      "employment_count", "union_employment_count",
                      "collective_bargain_employment_count", "percent_union",
                      "percent_collective_bargain", "state_min_wage",
                      "state_min_wage_2020_adj", "fed_min_wage",
                      "fed_min_wage_2020_adj", "effective_min_wage",
                      "effective_min_wage_2020_adj", "CPI_avg")
full_state_data <- full_state_data[, state_column_list] # reorder columns
full_state_data$party[is.na(full_state_data$party)] <- "No election" # replace party NAs
full_state_data$district[is.na(full_state_data$district)] <- "No election" # replace district NAs
full_state_data$party_binary[is.na(full_state_data$party_binary)] <- "No election" # replace district NAs
```

```{r}
range(full_state_data$year)
```

```{r}
summary(full_state_data)
```

#### National Dataframes

##### Creating Adjusted Wages Columns

```{r}
state_to_ntl <- full_state_data |>
  ungroup() %>% 
  mutate(adjusted_wage_prop = fed_min_wage / fed_min_wage_2020_adj, .after = year) |>
  distinct(year, .keep = TRUE) 
#  select(year:adjusted_wage_prop)
```

```{r}
full_ntl_data <- income_distribution |> 
  left_join(union_wages, by = "year") |>
  mutate(decade = paste0((year - year %% 10), "s"), .after = year)
```

```{r}
range(full_ntl_data$year)
```

### EDA

```{r}
summary(full_ntl_data)
summary(full_state_data)
```

#### Graphing Full State Data

##### For facets, use best judgement if by state, decade, year, or region

##### maybe make all states light grey and just choose outline outlier states and maybe regional averages

##### Party by state and year

```{r}
ggplot(full_state_data, aes(x = state_abbreviation, y = )) +
```

##### Min Wage by state and year (include fed (facet or use by decades where necessary)

# figure out spacing of graph

# can't do a line for federal minimum wage unless faceted by year instead of decade

```{r}
effective_min_wage_adj_graph1 <- full_state_data |> 
  filter(!is.na(regions)) |> 
  filter(effective_min_wage_2020_adj != fed_min_wage_2020_adj) |> 
  filter(state_abbreviation != "HI") |> 
  ggplot(aes(x = year)) +
  geom_line(aes(y = effective_min_wage_2020_adj, color = state_abbreviation)) +
  scale_color_manual(values = c(rep("gray", 34))) +
  geom_line(aes(y = fed_min_wage), color = "red", linewidth = .75) 

HI_effective_min_wage <- full_state_data |> 
  filter(!is.na(regions)) |> 
  filter(effective_min_wage_2020_adj != fed_min_wage_2020_adj) |> 
  filter(state_abbreviation == "HI") |> 
  mutate(effective_min_wage_2020_adj = effective_min_wage_2020_adj - .05)

CT_effective_min_wage <- full_state_data |> 
  filter(!is.na(regions)) |> 
  filter(effective_min_wage_2020_adj != fed_min_wage_2020_adj) |> 
  filter(state_abbreviation == "CT")

AK_effective_min_wage <- full_state_data |> 
  filter(!is.na(regions)) |> 
  filter(effective_min_wage_2020_adj != fed_min_wage_2020_adj) |> 
  filter(state_abbreviation == "AK")

CA_effective_min_wage <- full_state_data |> 
  filter(!is.na(regions)) |> 
  filter(effective_min_wage_2020_adj != fed_min_wage_2020_adj) |> 
  filter(state_abbreviation == "CA")
  

effective_min_wage_adj_graph1 +
  geom_line(data = HI_effective_min_wage, aes(y = effective_min_wage_2020_adj), color = "blue",linewidth = .7) +
  annotate("text", x=1994, y=9.5, label= "Hawaii", color = "blue") +
  geom_line(data = CT_effective_min_wage, aes(y = effective_min_wage_2020_adj), color = "#288225", linewidth = .7) +
  annotate("text", x=1985, y=7.5, label= "Connecticut", color = "#288225") +
  geom_line(data = AK_effective_min_wage, aes(y = effective_min_wage_2020_adj), color = "orange", linewidth = .7) +
  annotate("text", x=1985, y=10, label= "Alaska", color = "orange") +
  geom_line(data = CA_effective_min_wage, aes(y = effective_min_wage_2020_adj), color = "purple", linewidth = .7) +
  annotate("text", x=2016, y=12, label= "California", color = "purple") +
  annotate("text", x=2000, y=5.5, label= "Federal", color = "red") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "State effective minimum wage by Year (adjusted for 2020 $)",
       subtitle = "For states with an adjusted effective minimum wage above the federal level",
       x = "Year",
       y = "Effective minimum wage (2020 USD)")

rm(HI_effective_min_wage, CT_effective_min_wage,
   AK_effective_min_wage, CA_effective_min_wage)
```


```{r}
# abbreviation and decade
ggplot(full_state_data, aes(x = state_abbreviation)) +
  geom_point(aes(y = state_min_wage)) +
  geom_hline(aes(yintercept = fed_min_wage), color = "red") +
  facet_wrap(~decade, nrow = 5) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "State", 
       y = "State Minimum Wage")

# region and decade
ggplot(full_state_data, aes(x = regions)) +
  geom_point(aes(y = state_min_wage)) +
  geom_hline(aes(yintercept = fed_min_wage), color = "red") +
  facet_wrap(~decade, nrow = 5) +
  labs(x = "State", 
       y = "State Minimum Wage")

# region and year
ggplot(full_state_data, aes(x = regions)) +
  geom_point(aes(y = state_min_wage)) +
  geom_hline(aes(yintercept = fed_min_wage), color = "red") +
  facet_wrap(~year, nrow = 10) +
  labs(x = "State", 
       y = "State Minimum Wage")
```

##### Adjusted Min Wage by state and year (include adjusted fed (facet or use by decades where necessary)

# figure out spacing of graph

# can't do a line for adj federal minimum wage unless faceted by year instead of decade

# add a label for the line saying federal minimum wage

```{r}
# abbreviation and decade
ggplot(full_state_data, aes(x = state_abbreviation)) +
  geom_point(aes(y = state_min_wage_2020_adj)) +
  geom_hline(aes(yintercept = fed_min_wage_2020_adj), color = "red") +
  facet_wrap(~decade, nrow = 5) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "State", 
       y = "State Minimum Wage in 2020 Dollars")

# region and decade
ggplot(full_state_data, aes(x = regions)) +
  geom_point(aes(y = state_min_wage_2020_adj)) +
  geom_hline(aes(yintercept = fed_min_wage_2020_adj), color = "red") +
  facet_wrap(~decade, nrow = 5) +
  labs(x = "Region", 
       y = "State Minimum Wage in 2020 Dollars")

# region and year
ggplot(full_state_data, aes(x = regions)) +
  geom_point(aes(y = state_min_wage_2020_adj)) +
  geom_hline(aes(yintercept = fed_min_wage_2020_adj), color = "red") +
  facet_wrap(~year, nrow = 10) +
  labs(x = "Region", 
       y = "State Minimum Wage in 2020 Dollars")
```

##### Union employment, CB employment, and full employment (facet by decade)

# should we take the average value per decade?

# add a key for the color of the points

# fix spacing because union employment count is not visible

```{r}
# state and decade
ggplot(full_state_data, aes(x = state_abbreviation)) +
  geom_point(aes(y = employment_count), color = "red") +
  geom_point(aes(y = union_employment_count), color = "blue") +
  geom_point(aes(y = collective_bargain_employment_count), color = "green") +
  facet_wrap(~decade, nrow = 5) +
  labs(x = "State", 
       y = "Number of People Employed")

# region and decade
ggplot(full_state_data, aes(x = regions)) +
  geom_point(aes(y = employment_count), color = "red") +
  geom_point(aes(y = union_employment_count), color = "blue") +
  geom_point(aes(y = collective_bargain_employment_count), color = "green") +
  facet_wrap(~decade, nrow = 5) +
  labs(x = "Region", 
       y = "Number of People Employed")
```

##### percent union and percent collective bargaining

# should we take the average value per decade?

# add a key for the color of the points

```{r}
# state and decade
ggplot(full_state_data, aes(x = state_abbreviation)) +
  geom_point(aes(y = percent_union), color = "red") +
  geom_point(aes(y = percent_collective_bargain), color = "blue") +
  facet_wrap(~decade, nrow = 5) +
  labs(x = "State", 
       y = "Number of People Employed")

# region and decade
ggplot(full_state_data, aes(x = regions)) +
  geom_point(aes(y = percent_union), color = "red") +
  geom_point(aes(y = percent_collective_bargain), color = "blue") +
  facet_wrap(~decade, nrow = 5) +
  labs(x = "Region", 
       y = "Number of People Employed")
```

## Modeling

## Conclusion
